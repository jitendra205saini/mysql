<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>LeadManagement Chatbot</title>

<style>

body {
  font-family: 'Segoe UI', Arial, sans-serif;
  background: #0f0f0f;
  color: #e0e0e0;
  margin: 0;
  padding: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  animation: fadeIn 0.4s ease-in-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(15px); }
  to { opacity: 1; transform: translateY(0); }
}

h2 {
  margin-bottom: 20px;
  font-size: 26px;
  color: #fff;
  text-shadow: 0 0 8px rgba(255,255,255,0.2);
}


#chat-container {
  width: 90%;
  max-width: 1100px;
  background: #1a1a1a;
  border-radius: 20px;
  padding: 30px;
  height: 70vh;
  overflow-y: auto;
  box-shadow: 0 10px 40px rgba(0,0,0,0.6);
  scrollbar-width: thin;
}

.message {
  margin: 18px 0;
  padding: 18px 22px;
  border-radius: 18px;
  max-width: 90%;
  word-wrap: break-word;
  clear: both;
  animation: fadeInMsg 0.3s ease-in-out;
}

@keyframes fadeInMsg {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.user {
  background: #006d5b;
  color: white;
  float: right;
  border-bottom-right-radius: 4px;
}

.bot {
  background: #292929;
  color: #e0e0e0;
  float: left;
  border-bottom-left-radius: 4px;
}


.typing {
  width: 60px;
  height: 14px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #ccc;
  animation: blink 1s infinite ease-in-out;
}

.dot:nth-child(2) { animation-delay: 0.2s; }
.dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes blink {
  0%, 80% { opacity: 0.2; }
  40% { opacity: 1; }
}


#input-area {
  width: 90%;
  max-width: 1100px;
  background: #1b1b1b;
  padding: 15px;
  border-radius: 16px;
  display: flex;
  box-shadow: 0 5px 20px rgba(0,0,0,0.5);
  margin-top: 15px;
}

#user-input {
  flex: 1;
  padding: 14px;
  border-radius: 12px;
  border: 1px solid #333;
  background: #262626;
  color: #e0e0e0;
  font-size: 16px;
}

button {
  padding: 14px 26px;
  margin-left: 12px;
  background: #4caf50;
  border: none;
  border-radius: 12px;
  color: white;
  font-weight: bold;
  cursor: pointer;
}

button:hover { background: #43a047; }


.styled-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
  font-size: 14px;
  background: #242424;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 5px 20px rgba(0,0,0,0.3);
}

.styled-table thead {
  background: #1a73e8;
  color: white;
}

.styled-table th, 
.styled-table td {
  padding: 12px 10px;
  border-bottom: 1px solid #333;
}

tbody tr:nth-child(even) { background: #2d2d2d; }
tbody tr:hover { background: #383838; }


.pending-confirm {
  background: #ffd54f !important;
  color: black !important;
}
</style>
</head>

<body>
<h2>LeadManagement DB Chatbot</h2>

<div id="chat-container"></div>

<div id="input-area">
  <input type="text" id="user-input" placeholder="Ask any database question..." />
  <button onclick="sendMessage()">Send</button>
</div>

<script>
const chatContainer = document.getElementById("chat-container");


function escapeHtml(text) {
  const div = document.createElement("div");
  div.textContent = text || "";
  return div.innerHTML;
}

function addMessage(sender, content, highlight = false) {
  const div = document.createElement("div");
  div.classList.add("message", sender);
  if (highlight) div.classList.add("pending-confirm");
  div.innerHTML = content;
  chatContainer.appendChild(div);
  chatContainer.scrollTop = chatContainer.scrollHeight;
}


function showTyping() {
  const div = document.createElement("div");
  div.classList.add("message", "bot");
  div.innerHTML = `
    <div class="typing">
      <div class="dot"></div><div class="dot"></div><div class="dot"></div>
    </div>
  `;
  chatContainer.appendChild(div);
  chatContainer.scrollTop = chatContainer.scrollHeight;
  return div;
}

async function sendMessage() {
  const input = document.getElementById("user-input");
  const question = input.value.trim();
  if (!question) return;

  addMessage("user", escapeHtml(question));
  input.value = "";

  const typingBubble = showTyping();

  try {
    const res = await fetch("/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ question })
    });

    const data = await res.json();
    typingBubble.remove();

    let reply = "";
    let highlight = false;


    if (data.sql) {
      reply += `
        <strong style="color:#4caf50;">SQL:</strong>
        <code style="background:#333;padding:10px 14px;border-radius:10px;display:block;margin:12px 0;color:#e0e0e0;">
          ${escapeHtml(data.sql)}
        </code>
      `;
    }

    const ans = data.answer;

 
    if (ans && ans.columns && ans.rows) {
      const columns = ans.columns;
      const rows = ans.rows;

      let header = columns.map(c => `<th>${escapeHtml(c)}</th>`).join("");
      let body = rows
        .map(r => `<tr>${columns.map(c => `<td>${escapeHtml(r[c])}</td>`).join("")}</tr>`)
        .join("");

      reply += `
        <table class="styled-table">
          <thead><tr>${header}</tr></thead>
          <tbody>${body}</tbody>
        </table>
        <small style="color:#888;float:right;margin-top:5px;">
          ${rows.length} row${rows.length > 1 ? "s" : ""} returned
        </small>
      `;
    } else {
      const s = typeof ans === "string" ? ans : JSON.stringify(ans);
      reply += s.replace(/\n/g, "<br>");
      if (s.includes("dangerous") || s.includes("YES to confirm")) highlight = true;
    }

    addMessage("bot", reply, highlight);

  } catch (err) {
    typingBubble.remove();
    addMessage("bot", `<span style="color:#ff5252;">Error: ${escapeHtml(err.message)}</span>`);
  }

  input.focus();
}

document.getElementById("user-input").addEventListener("keypress", e => {
  if (e.key === "Enter") sendMessage();
});
</script>
</body>
</html>
